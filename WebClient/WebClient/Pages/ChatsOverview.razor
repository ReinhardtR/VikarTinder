@page "/chat"
@using HttpClients.Services
@using HttpClients
@inject ChatService ChatService
@inject NavigationManager NavigationManager

<PageTitle>Chat</PageTitle>
@* *@
@* <div> *@
@*     <h1>Create Chat Form</h1> *@
@*     <CreateChatForm /> *@
@* </div> *@

@if (chats == null && errorLabel == null)
{
    <p>Loading...</p>
} 
else if (errorLabel != null)
{
    <p>Error: @errorLabel</p>
} 
else if (chats != null)
{
    <MudStack class="object-left" Spacing="0" AlignItems="AlignItems.Stretch">
        <h1>Chats</h1>
        
        @foreach (BasicChatDTO chat in chats)
        {
            <MudButton OnClick="() => MoveToChat(chat.Id)">
                <MudPaper class="ma-1" Width="100%" >
                <MudStack Row="true" Class="pa-4" >
                        <MudAvatar Color="Color.Secondary" >@chat.UserIds.Single(u => u != userId)</MudAvatar>
                        <MudStack Justify="Justify.Center" Spacing="0">
                            <MudText Typo="Typo.body1">@chat.UserIds.Single(u => u != userId)</MudText>
                            <MudText Typo="Typo.body2">Sample Emailgmail.com</MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudButton>
            
        }
    </MudStack>
}

@code {
    // replace with auth stuff
    private readonly int userId = 2;
    
    private ICollection<BasicChatDTO>? chats;
    private string? errorLabel;

    private int tempPartnerId;
    protected override async Task OnInitializedAsync()
    {
        await FetchChats();
    }

    private async Task FetchChats()
    {
        try
        {
            errorLabel = null;
            ChatOverviewDTO chatOverview = await ChatService.GetChatOverviewAsync(userId);

            chats = chatOverview.Chats;
        }
        catch (Exception e)
        {
            errorLabel = e.Message;
            chats = null;
        }
    }

    private void assignPartner(BasicChatDTO chatDto)
    {
        tempPartnerId = chatDto.UserIds.Single(u => u != userId);
    }

    private void MoveToChat(int chatToGoTo)
    {
        NavigationManager.NavigateTo($"/chat/{chatToGoTo}");
    }

}